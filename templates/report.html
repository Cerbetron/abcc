<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agent Usage Report</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="container py-4">
  <h1 class="mb-4">Agent Usage Report</h1>
  <h4>Total Cost: $<span id="total-cost">0.0000</span></h4>
  <div class="my-3">
    <canvas id="costChart" height="100"></canvas>
  </div>
  <table class="table table-striped" id="usage-table">
    <thead>
      <tr>
        <th>Agent Name</th>
        <th>Model Used</th>
        <th>Input Tokens</th>
        <th>Output Tokens</th>
        <th>Cost (USD)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
async function fetchData() {
  const res = await fetch('/log.csv?' + Date.now());
  const text = await res.text();
  const lines = text.trim().split('\n');
  const data = lines.slice(1).map(l => l.split(','));
  const tbody = document.querySelector('#usage-table tbody');
  tbody.innerHTML = '';
  let total = 0;
  let chartData = {};
  for (const row of data) {
    const [name, model, input, output, cost] = row;
    const c = parseFloat(cost);
    total += c;
    chartData[name] = (chartData[name] || 0) + c;
    let badgeClass = 'bg-success';
    if (c >= 0.05) badgeClass = 'bg-danger';
    else if (c >= 0.01) badgeClass = 'bg-warning text-dark';
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${name}</td>
      <td>${model}</td>
      <td>${input}</td>
      <td>${output}</td>
      <td><span class="badge ${badgeClass}">${c.toFixed(4)}</span></td>
    </tr>`);
  }
  document.getElementById('total-cost').textContent = total.toFixed(4);
  updateChart(chartData);
}

let pieChart;
function updateChart(chartData) {
  const ctx = document.getElementById('costChart');
  const labels = Object.keys(chartData);
  const values = Object.values(chartData);
  if (pieChart) pieChart.destroy();
  pieChart = new Chart(ctx, {
    type: 'pie',
    data: {labels: labels, datasets: [{data: values}]},
  });
}

fetchData();
setInterval(fetchData, 5000);
</script>
</body>
</html>
